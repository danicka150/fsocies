// server.js
import express from 'express';
import bodyParser from 'body-parser';
import cors from 'cors';
import pg from 'pg';
import path from 'path';
import { fileURLToPath } from 'url';

const { Pool } = pg;
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();
const PORT = process.env.PORT || 10000;

app.use(cors());
app.use(bodyParser.json());

// ======== ĞŸĞ°Ğ¿ĞºĞ° Ñ Ñ„Ñ€Ğ¾Ğ½Ñ‚Ğ¾Ğ¼ ========
app.use(express.static(__dirname)); // Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ²ÑÑ‘ Ğ² Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ğ¿Ğ°Ğ¿ĞºĞµ

// ======== ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº PostgreSQL ========
const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  ssl: { rejectUnauthorized: false }
});

async function initDB() {
  try {
    await pool.query(`
      CREATE TABLE IF NOT EXISTS users (
        id SERIAL PRIMARY KEY,
        username VARCHAR(50) UNIQUE NOT NULL,
        password VARCHAR(100) NOT NULL
      );
      CREATE TABLE IF NOT EXISTS threads (
        id SERIAL PRIMARY KEY,
        user_id INTEGER REFERENCES users(id),
        title VARCHAR(255) NOT NULL,
        content TEXT,
        created_at TIMESTAMP DEFAULT NOW()
      );
      CREATE TABLE IF NOT EXISTS posts (
        id SERIAL PRIMARY KEY,
        thread_id INTEGER REFERENCES threads(id),
        user_id INTEGER REFERENCES users(id),
        content TEXT NOT NULL,
        created_at TIMESTAMP DEFAULT NOW()
      );
    `);
    console.log('âœ… Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞµĞ½Ñ‹ / ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ñ‹');
  } catch (err) {
    console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ DB:', err);
  }
}

// ======== Ğ¤Ñ€Ğ¾Ğ½Ñ‚: Ğ¾Ñ‚Ğ´Ğ°Ñ‘Ğ¼ index.html ========
app.get('/', (req, res) => {
  res.sendFile(path.join(__dirname, 'index.html'));
});

// ======== API ========
// Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ
app.post('/api/register', async (req, res) => {
  const { username, password } = req.body;
  if (!username || !password) return res.status(400).send('ĞĞ¸Ğº Ğ¸ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹');

  try {
    const result = await pool.query(
      'INSERT INTO users (username, password) VALUES ($1, $2) RETURNING id',
      [username, password]
    );
    res.json({ id: result.rows[0].id });
  } catch (err) {
    if (err.code === '23505') res.status(400).send('ĞĞ¸Ğº ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚');
    else res.status(500).send('ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğ°');
  }
});

// Ğ›Ğ¾Ğ³Ğ¸Ğ½
app.post('/api/login', async (req, res) => {
  const { username, password } = req.body;
  if (!username || !password) return res.status(400).send('ĞĞ¸Ğº Ğ¸ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹');

  try {
    const result = await pool.query(
      'SELECT id FROM users WHERE username=$1 AND password=$2',
      [username, password]
    );
    if (result.rows.length === 0) return res.status(400).send('ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ½Ğ¸Ğº Ğ¸Ğ»Ğ¸ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ');
    res.json({ id: result.rows[0].id });
  } catch (err) {
    res.status(500).send('ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğ°');
  }
});

// Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ñ‚ĞµĞ¼Ñ‹
app.post('/api/thread', async (req, res) => {
  const { title, content, user_id } = req.body;
  if (!title || !user_id) return res.status(400).send('ĞÑƒĞ¶Ğ½Ñ‹ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº Ğ¸ ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ');

  try {
    const result = await pool.query(
      'INSERT INTO threads (title, content, user_id) VALUES ($1, $2, $3) RETURNING id',
      [title, content, user_id]
    );
    res.json({ id: result.rows[0].id });
  } catch (err) {
    res.status(500).send('ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğ°');
  }
});

// Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ‚ĞµĞ¼
app.get('/api/threads', async (req, res) => {
  try {
    const result = await pool.query('SELECT * FROM threads ORDER BY created_at DESC');
    res.json(result.rows);
  } catch (err) {
    res.status(500).send('ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğ°');
  }
});

// ĞŸĞ¾ÑÑ‚Ñ‹ Ğ¿Ğ¾ Ñ‚ĞµĞ¼Ğµ
app.get('/api/thread/:id/posts', async (req, res) => {
  const threadId = req.params.id;
  try {
    const result = await pool.query(
      'SELECT * FROM posts WHERE thread_id=$1 ORDER BY created_at ASC',
      [threadId]
    );
    res.json(result.rows);
  } catch (err) {
    res.status(500).send('ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğ°');
  }
});

// Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾ÑÑ‚Ğ°
app.post('/api/thread/:id/post', async (req, res) => {
  const threadId = req.params.id;
  const { content, user_id } = req.body;
  if (!content || !user_id) return res.status(400).send('ĞÑƒĞ¶Ğ½Ñ‹ Ñ‚ĞµĞºÑÑ‚ Ğ¸ ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ');

  try {
    const result = await pool.query(
      'INSERT INTO posts (thread_id, user_id, content) VALUES ($1, $2, $3) RETURNING id',
      [threadId, user_id, content]
    );
    res.json({ id: result.rows[0].id });
  } catch (err) {
    res.status(500).send('ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğ°');
  }
});

// ======== Ğ¡Ğ¢ĞĞ Ğ¢ Ğ¡Ğ•Ğ Ğ’Ğ•Ğ Ğ ========
app.listen(PORT, async () => {
  console.log(`ğŸš€ fsociety running on port ${PORT}`);
  try {
    await pool.connect();
    console.log('âœ… PostgreSQL connected');
    await initDB();
  } catch (err) {
    console.error('âŒ DB INIT ERROR:', err);
  }
});

